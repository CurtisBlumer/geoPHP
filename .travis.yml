#%YAML 1.2
#
# @file .travis.yml
#

language: php

php:
  - 5.3
  - 5.4
  - 5.5
  - 5.6
  - 7.0
  - hhvm

matrix:
  include:
    - php: 7.0
      env: BLACKFIRE=on
  allow_failures:
    - php: "5.3"
    - php: "5.4"
    - php: "5.5"
  fast_finish: true

env:
  - GEOPHP_RUN_TESTS=1

before_install:
  - |
      if [[ "${BLACKFIRE}" = "on" ]]; then
        openssl aes-256-cbc -K $encrypted_3c1c36ea615f_key -iv $encrypted_3c1c36ea615f_iv -in .blackfire.travis.ini.enc -out ~/.blackfire.ini -d
        curl -L https://blackfire.io/api/v1/releases/agent/linux/amd64 | tar zxpf -
        chmod 755 agent && ./agent --config=~/.blackfire.ini --socket=unix:///tmp/blackfire.sock &
      fi

install:
  - travis_retry composer install

before_install:
    - |
        if [[ "${BLACKFIRE}" = "on" ]]; then
            openssl aes-256-cbc -K $encrypted_16ab3ffdcd52_key -iv $encrypted_16ab3ffdcd52_iv -in .blackfire.travis.ini.enc -out ~/.blackfire.ini -d
            curl -L https://blackfire.io/api/v1/releases/agent/linux/amd64 | tar zxpf -
            chmod 755 agent && ./agent --config=~/.blackfire.ini --socket=unix:///tmp/blackfire.sock &
        fi

install:
    - travis_retry composer install

before_script:
    - phpenv config-rm xdebug.ini || true
    - |
        if [[ "${BLACKFIRE}" = "on" ]]; then
            curl -L https://blackfire.io/api/v1/releases/probe/php/linux/amd64/$(phpenv version-name | tr -d '.')-zts | tar zxpf -
            echo "extension=$(pwd)/$(ls blackfire-*.so | tr -d '[[:space:]]')" > ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/blackfire.ini
            echo "blackfire.agent_socket=unix:///tmp/blackfire.sock" >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/blackfire.ini
        fi

script:
  - cd ${TRAVIS_BUILD_DIR}/tests
  - |
      if [[ "${BLACKFIRE}" = "on" ]]; then
        mkdir -p ${TRAVIS_BUILD_DIR}/logs/coverage
        phpunit --coverage-clover ${TRAVIS_BUILD_DIR}/logs/coverage/clover.xml --verbose --colors --stderr tests
      else
        phpunit --verbose --colors --stderr tests
      fi

after_success:
  - |
      if [[ "${BLACKFIRE}" = "on" ]]; then
        php ${TRAVIS_BUILD_DIR}/vendor/bin/coveralls -v
      fi
